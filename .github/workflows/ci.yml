name: Go App CI/CD

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Docker Compose
        run: sudo apt-get update && sudo apt-get install -y docker-compose

      - name: Build Docker Compose services
        run: docker-compose build

      - name: Copy project files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          source: "."  # –∫–æ–ø–∏—Ä—É–µ–º –≤—Å—ë
          target: "~/go-app"

      - name: SSH and deploy on VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            cd ~/go-app

            # ‚úÖ –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É –¥–ª—è –±—ç–∫–∞–ø–æ–≤, –µ—Å–ª–∏ –Ω–µ—Ç
            mkdir -p ~/db_backups

            # üì¶ –î–µ–ª–∞–µ–º –¥–∞–º–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–∞–π–ª —Å —Ç–∞–π–º—à—Ç–∞–º–ø–æ–º
            docker exec $(docker ps -qf "name=db") pg_dump -U postgres tipOnlineShop > ~/db_backups/backup_$(date +"%Y%m%d_%H%M%S").sql

            # üßπ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            docker-compose down

            # üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Å –ø–µ—Ä–µ—Å–±–æ—Ä–∫–æ–π
            docker-compose up -d --build
